<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Collaboration Space</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='bundle.js') }}"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <style>
        /* Admin-specific styles */
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="buttons">
                <button onclick="openAssignOptions()">Assign</button>
                <button onclick="openApproveRequests()">Pending Requests</button>
                <a href="{{ url_for('dashboard', username=username) }}" class="styled-button">‚Üê</a>
            </div>

            <div class="chatbox">
                <div class="chatbox-header">
                    <span>Chat</span>
                    <button id="whiteboardToggleBtn">Show Whiteboard</button>
                </div>
                <div class="messages" id="messagesContainer"></div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
                    <button class="send-button" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <div class="voice-call-container">
                <h4>Voice Call</h4>
                <button id="joinBtn">Join Call</button>
                <button id="leaveBtn" disabled>Leave Call</button>
            </div>
        </div>
        
        <div class="right-panel" id="taskPanel">
            <button class="panel-toggle" id="taskPanelToggle">‚â°</button>
            <div class="task-panel-content">
                <h3>Group Tasks</h3>
                
                <div class="task-section">
                    <div class="collapsible">‚úÖ Done</div>
                    <ul id="done-tasks">
                        {% for task in completed_tasks %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No completed tasks</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="task-section">
                    <div class="collapsible">üéØ To Be Done This Week</div>
                    <ul id="this-week-tasks">
                        {% for task in tasks_this_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div>
                                <span style="font-weight: bold;">Deadline:</span> {{ task.deadline }}
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for this week</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="task-section">
                    <div class="collapsible">üóìÔ∏è Tasks Next Week</div>
                    <ul id="next-week-tasks">
                        {% for task in tasks_next_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for next week</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-container" id="approveRequestsContainer" style="display: none;">
        <h3>Pending Join Requests</h3>
        <ul id="pending-requests-list">
            {% for username in pending_requests %}
            <li>
                {{ username }}
                <form action="{{ url_for('approve_request', group_id=group_id, username=username) }}" method="post" style="display: inline;">
                    <button type="submit">Approve</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        <button onclick="closeApproveRequests()">Close</button>
    </div>

    <div class="floating-container" id="roleManagementContainer" style="display: none;">
        <h3>Manage & Create Roles</h3>
        <div id="roleManagementContent">
        </div>
        <button onclick="closeRoleManagement()">Close</button>
    </div>

    <div class="floating-container" id="assignOptionsContainer" style="display: none;">
        <h3>Assign Action</h3>
        <p>Please choose an action:</p>
        <button onclick="openAssignRoleOptions()">Assign Role</button>
        <button onclick="openAssignTaskOptions()">Assign Task</button> <button onclick="closeAssignOptions()">Cancel</button>
    </div>

    <div class="floating-container" id="assignRoleOptionsContainer" style="display: none;">
        <h3>Role Assignment Options</h3>
        <p>What role action do you want to perform?</p>
        <button onclick="openRoleManagement()">Manage & Create Roles</button>
        <button onclick="openAssignExistingRoleModal()">Assign Existing Role to Members</button>
        <button onclick="closeAssignRoleOptions()">Cancel</button>
    </div>

    <div class="floating-container" id="assignExistingRoleContainer" style="display: none;">
        <h3>Assign Existing Role</h3>
        <form id="assignExistingRoleForm">
            <label for="select-role-to-assign">Select Role:</label>
            <select id="select-role-to-assign" required>
                </select>
            <br>
            <label for="select-users-for-role">Select Users (Ctrl/Cmd + click to select multiple):</label>
            <select id="select-users-for-role" multiple required>
                {% for member in members %}
                <option value="{{ member.username }}">{{ member.username }}</option>
                {% endfor %}
            </select>
            <br>
            <button type="button" onclick="submitAssignExistingRole()">Assign Role</button>
            <button type="button" class="cancel-button" onclick="closeAssignExistingRoleModal()">Cancel</button>
        </form>
    </div>

    <div class="floating-container" id="assignTaskOptionsContainer" style="display: none;">
        <h3>Task Assignment Options</h3>
        <p>Do you want to create a new project with tasks, or assign an existing task?</p>
        <button onclick="openCreateProjectModal()">Create Project</button>
        <button onclick="openAssignExistingTaskModal()">Assign Existing Task</button>
        <button type="button" class="cancel-button" onclick="closeAssignTaskOptions()">Cancel</button>
    </div>

    <div class="floating-container" id="createProjectContainer" style="display: none;">
        <h3>Create New Project</h3>
        <form id="createProjectForm">
            <label for="project-name">Project Name:</label>
            <input type="text" id="project-name" placeholder="Enter project name" required>
            <label for="project-description">Project Description:</label>
            <textarea id="project-description" placeholder="Describe the project" rows="3"></textarea>

            <h4>Project Tasks:</h4>
            <div id="project-tasks-list">
                </div>
            <button type="button" onclick="addProjectTask()">Add Task to Project</button>
            <br>
            <button type="button" onclick="submitProject()">Create Project with Tasks</button>
            <button type="button" class="cancel-button" onclick="closeCreateProjectModal()">Cancel</button>
        </form>
    </div>

    <div class="floating-container" id="assignExistingTaskContainer" style="display: none;">
        <h3>Assign Existing Task</h3>
        <form id="assignExistingTaskForm">
            <label for="select-existing-task">Select Task:</label>
            <select id="select-existing-task" required>
                </select>
            <br>
            <label for="assign-task-to-type">Assign To:</label>
            <select id="assign-task-to-type" onchange="toggleAssignToSelection()">
                <option value="user">User</option>
                <option value="role">Role</option>
                <option value="everyone">Everyone</option>
            </select>
            
            <div id="assign-task-user-selection">
                <label for="assign-task-to-user">Select User:</label>
                <select id="assign-task-to-user">
                    {% for member in members %}
                    <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="assign-task-role-selection" style="display: none;">
                <label for="assign-task-to-role">Select Role:</label>
                <select id="assign-task-to-role">
                    </select>
            </div>
            <br>
            <button type="button" onclick="submitAssignExistingTask()">Assign Task</button>
            <button type="button" class="cancel-button" onclick="closeAssignExistingTaskModal()">Cancel</button>
        </form>
    </div>


    <div id="whiteboardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:8px; padding:20px; width:80%; max-width:800px; max-height:90vh; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Whiteboard</h3>
                <button onclick="closeWhiteboard()" style="background:#ff5555; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Close</button>
            </div>
            <canvas id="whiteboardCanvas" style="border:1px solid #ccc; background-color:white; width:100%; height:500px;"></canvas>
            <div style="text-align:center; margin-top:10px;">
                <button onclick="clearWhiteboard()" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Clear Whiteboard</button>
            </div>
        </div>
    </div>
    
<script>
    // Admin credentials and API configuration
    const username = "{{ username }}";
    const groupId = "{{ group_id }}";
    const APP_ID = "8f0029e7fd2047339fe6822ab5b59abd";
    const CHANNEL = "{{ group_id }}";
    const UID = Math.floor(Math.random() * 10000);
    let client = null;
    let localTrack = null;

    let availableCustomRoles = []; // To store custom roles fetched from the server
    let projectIdCounter = 0; // To uniquely identify tasks added to a project form

    // --- Global Data Holders ---
    let projectTasks = []; // Array to hold tasks for the current project being created
    let existingTasks = []; // Array to hold tasks fetched for 'Assign Existing Task'

    // Initialize admin interface
    function initAdminInterface() {
        fetchMessages();
        initCollapsibleSections();
        
        // Setup all event listeners
        document.getElementById('whiteboardToggleBtn').addEventListener('click', openWhiteboard);
        document.getElementById('taskPanelToggle').addEventListener('click', toggleTaskPanel);
        document.getElementById('joinBtn').addEventListener('click', joinVoiceCall);
        document.getElementById('leaveBtn').addEventListener('click', leaveVoiceCall);
    }

    function initCollapsibleSections() {
        document.querySelectorAll('.collapsible').forEach(el => {
            el.addEventListener('click', () => toggleCollapsible(el));
            el.classList.remove('collapsed');
            el.nextElementSibling.style.display = 'block';
        });
    }

    // Message handling (No change)
    function fetchMessages() {
        console.log("Fetching messages...");
        fetch(`/get_messages/${groupId}`)
            .then(response => response.json())
            .then(data => {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                data.messages.forEach(msg => {
                    const msgElement = document.createElement('p');
                    msgElement.textContent = `${msg.timestamp} - ${msg.sender}: ${msg.message}`;
                    messagesContainer.appendChild(msgElement);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (message) {
            fetch(`/send_message/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sender: username, message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = '';
                    fetchMessages();
                } else {
                    alert('Failed to send message: ' + data.message);
                }
            })
            .catch(error => console.error('Error sending message:', error));
        }
    }

    // --- Main Assign Options Modal Functions ---
    function openAssignOptions() {
        document.getElementById('assignOptionsContainer').style.display = 'block';
    }

    function closeAssignOptions() {
        document.getElementById('assignOptionsContainer').style.display = 'none';
    }

    // --- Assign Role Options Modal Functions ---
    function openAssignRoleOptions() {
        closeAssignOptions(); // Close the first options modal
        document.getElementById('assignRoleOptionsContainer').style.display = 'block';
    }

    function closeAssignRoleOptions() {
        document.getElementById('assignRoleOptionsContainer').style.display = 'none';
    }

    // --- Assign Existing Role Modal Functions ---
    function openAssignExistingRoleModal() {
        closeAssignRoleOptions(); // Close the role options modal

        fetch(`/get_group_members_with_roles/${groupId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && Array.isArray(data.available_custom_roles)) {
                    availableCustomRoles = data.available_custom_roles;
                    populateRoleSelection(availableCustomRoles);
                    document.getElementById('assignExistingRoleContainer').style.display = 'block';
                } else {
                    alert('Failed to load custom roles: ' + (data.message || 'Unknown error'));
                    console.error('Error loading custom roles:', data);
                }
            })
            .catch(err => {
                console.error('Error fetching custom roles:', err);
                alert('Error fetching custom roles.');
            });
    }

    function populateRoleSelection(roles) {
        const selectRole = document.getElementById('select-role-to-assign');
        selectRole.innerHTML = '<option value="">-- Select a Role --</option>'; // Default option
        if (roles && roles.length > 0) {
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                selectRole.appendChild(option);
            });
        }
    }

    function closeAssignExistingRoleModal() {
        document.getElementById('assignExistingRoleContainer').style.display = 'none';
        document.getElementById('assignExistingRoleForm').reset();
    }

    function submitAssignExistingRole() {
        const selectedRole = document.getElementById('select-role-to-assign').value;
        const selectedUsersElement = document.getElementById('select-users-for-role');
        const selectedUsers = Array.from(selectedUsersElement.selectedOptions).map(option => option.value);

        if (!selectedRole) {
            alert('Please select a role.');
            return;
        }
        if (selectedUsers.length === 0) {
            alert('Please select at least one user.');
            return;
        }

        const updates = {};
        selectedUsers.forEach(user => {
            updates[user] = {
                custom_roles_to_assign: [selectedRole]
            };
        });

        fetch(`/update_roles/${groupId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeAssignExistingRoleModal();
                location.reload();
            } else {
                alert('Failed to assign role: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error assigning role:', err);
            alert('Error assigning role.');
        });
    }

    // --- Role Management Functions ---
    function openRoleManagement() {
        closeAssignRoleOptions(); // Close the role options modal first

        fetch(`/get_group_members_with_roles/${groupId}`)
            .then(res => res.json())
            .then(data => {
                const content = document.getElementById('roleManagementContent');
                if (data.success && Array.isArray(data.members)) {
                    let html = '<form id="roleForm">';
                    data.members.forEach(user => {
                        html += `
                        <div>
                            <strong>${user.username}:</strong>
                            <select name="primary_role_${user.username}" data-username="${user.username}">
                                <option value="admin" ${user.primary_role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="member" ${user.primary_role === 'member' ? 'selected' : ''}>Member</option>
                            </select>
                        </div>
                        `;
                        html += `
                        <div style="margin-left: 20px;">
                            Custom Roles:
                            <select multiple name="custom_roles_${user.username}" data-username="${user.username}" class="custom-role-select">
                                ${data.available_custom_roles.map(role => `
                                    <option value="${role}" ${user.custom_roles.includes(role) ? 'selected' : ''}>${role}</option>
                                `).join('')}
                            </select>
                        </div>
                        `;
                    });
                    
                    html += '<button type="button" onclick="saveRoles()">Save Roles</button>';
                    html += '</form>';

                    html += `
                    <hr>
                    <h4>Create New Custom Role</h4>
                    <input type="text" id="newRoleName" placeholder="New Role Name">
                    <button type="button" onclick="createNewRole()">Create Role</button>
                    `;

                    // Section for deleting custom roles
                    html += `
                    <hr>
                    <h4>Remove Custom Role</h4>
                    <select id="roleToDelete">
                        <option value="">-- Select Role to Remove --</option>
                        ${data.available_custom_roles.map(role => `
                            <option value="${role}">${role}</option>
                        `).join('')}
                    </select>
                    <button type="button" class="cancel-button" onclick="deleteCustomRole()">Remove Role</button>
                    `;

                    content.innerHTML = html;
                    document.getElementById('roleManagementContainer').style.display = 'block';
                } else {
                    content.innerHTML = 'Error loading group members or roles.';
                    console.error('Error from server:', data.message);
                }
            })
            .catch(err => {
                console.error('Error fetching group members:', err);
                document.getElementById('roleManagementContent').innerHTML = 'Error loading group members.';
            });
    }

    function createNewRole() {
        const newRoleName = document.getElementById('newRoleName').value.trim();
        if (!newRoleName) {
            alert('Please enter a role name.');
            return;
        }

        fetch(`/create_role/${groupId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_name: newRoleName })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                openRoleManagement(); // Refresh the modal to show the new role
            } else {
                alert('Failed to create role: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error creating role:', err);
            alert('Error creating role.');
        });
    }

    function deleteCustomRole() {
        const roleToDelete = document.getElementById('roleToDelete').value;
        if (!roleToDelete) {
            alert('Please select a role to remove.');
            return;
        }

        if (!confirm(`Are you sure you want to remove the role "${roleToDelete}"? This action cannot be undone.`)) {
            return;
        }

        fetch(`/delete_role/${groupId}`, { // You'll need to implement this Flask route
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_name: roleToDelete })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                openRoleManagement(); // Refresh the modal to show updated roles
            } else {
                alert('Failed to remove role: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error removing role:', err);
            alert('Error removing role.');
        });
    }

    function closeRoleManagement() {
        document.getElementById('roleManagementContainer').style.display = 'none';
        openAssignRoleOptions(); // Return to the role options menu
    }

    function saveRoles() {
        const primaryRoleSelects = document.querySelectorAll('#roleForm select[name^="primary_role_"]');
        const customRoleSelects = document.querySelectorAll('#roleForm select[name^="custom_roles_"]');
        
        const updates = {};

        primaryRoleSelects.forEach(select => {
            const username = select.dataset.username;
            if (!updates[username]) updates[username] = {};
            updates[username]['primary_role'] = select.value;
        });

        customRoleSelects.forEach(select => {
            const username = select.dataset.username;
            if (!updates[username]) updates[username] = {};
            
            const selectedOptions = Array.from(select.selectedOptions).map(option => option.value);
            const allOptions = Array.from(select.options).map(option => option.value);

            updates[username]['custom_roles_to_assign'] = selectedOptions;
            updates[username]['custom_roles_to_unassign'] = allOptions.filter(role => !selectedOptions.includes(role));
        });

        fetch(`/update_roles/${groupId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Roles updated successfully!');
                closeRoleManagement();
                location.reload(); 
            } else {
                alert('Failed to update roles: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Failed to update roles');
        });
    }


    // --- NEW: Assign Task Options Modal Functions ---
    function openAssignTaskOptions() {
        closeAssignOptions(); // Close the main assign options modal
        document.getElementById('assignTaskOptionsContainer').style.display = 'block';
    }

    function closeAssignTaskOptions() {
        document.getElementById('assignTaskOptionsContainer').style.display = 'none';
        openAssignOptions(); // Go back to the main assign options
    }

    // --- NEW: Create Project Modal Functions ---
    function openCreateProjectModal() {
        closeAssignTaskOptions(); // Close task options
        document.getElementById('createProjectContainer').style.display = 'block';
        document.getElementById('createProjectForm').reset();
        document.getElementById('project-tasks-list').innerHTML = ''; // Clear previous tasks
        projectTasks = []; // Reset the array
        projectIdCounter = 0; // Reset counter for new project
    }

    function closeCreateProjectModal() {
        document.getElementById('createProjectContainer').style.display = 'none';
        document.getElementById('createProjectForm').reset();
        document.getElementById('project-tasks-list').innerHTML = '';
        projectTasks = [];
        projectIdCounter = 0;
        openAssignTaskOptions(); // Go back to task options
    }

    function addProjectTask() {
        const tasksList = document.getElementById('project-tasks-list');
        const taskId = `task-${projectIdCounter++}`;

        const taskEntryDiv = document.createElement('div');
        taskEntryDiv.className = 'task-entry';
        taskEntryDiv.id = taskId;
        taskEntryDiv.innerHTML = `
            <h5>Task #${projectIdCounter}</h5>
            <label for="${taskId}-name">Task Name:</label>
            <input type="text" id="${taskId}-name" placeholder="Task Name" required>
            
            <label for="${taskId}-description">Description:</label>
            <textarea id="${taskId}-description" placeholder="Task Description" rows="2"></textarea>
            
            <label for="${taskId}-week">Assign to Week:</label>
            <select id="${taskId}-week">
                <option value="this_week">This Week</option>
                <option value="next_week">Next Week</option>
                <option value="week_2">Week 2</option>
                <option value="week_3">Week 3</option>
                <option value="week_4">Week 4</option>
                </select>
            
            <label for="${taskId}-priority">Priority:</label>
            <select id="${taskId}-priority">
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
            
            <label for="${taskId}-assignee-type">Assign To:</label>
            <select id="${taskId}-assignee-type" onchange="toggleProjectTaskAssignee('${taskId}')">
                <option value="user">Specific User</option>
                <option value="role">Role</option>
                <option value="everyone">Everyone in Group</option>
            </select>

            <div id="${taskId}-user-select-div">
                <label for="${taskId}-assignee-user">Select User:</label>
                <select id="${taskId}-assignee-user">
                    {% for member in members %}
                    <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="${taskId}-role-select-div" style="display:none;">
                <label for="${taskId}-assignee-role">Select Role:</label>
                <select id="${taskId}-assignee-role"></select>
            </div>

            <button type="button" class="cancel-button" onclick="removeProjectTask('${taskId}')">Remove Task</button>
        `;
        tasksList.appendChild(taskEntryDiv);

        // Populate roles for the newly added task's role select
        populateProjectTaskRoles(taskId);
        // Ensure initial state of assignee selection is correct
        toggleProjectTaskAssignee(taskId);
    }

    function populateProjectTaskRoles(taskId) {
        const selectRole = document.getElementById(`${taskId}-assignee-role`);
        selectRole.innerHTML = ''; // Clear existing options
        if (availableCustomRoles && availableCustomRoles.length > 0) {
            availableCustomRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                selectRole.appendChild(option);
            });
        } else {
            selectRole.innerHTML = '<option value="">No custom roles available</option>';
        }
    }

    function toggleProjectTaskAssignee(taskId) {
        const assigneeType = document.getElementById(`${taskId}-assignee-type`).value;
        document.getElementById(`${taskId}-user-select-div`).style.display = (assigneeType === 'user') ? 'block' : 'none';
        document.getElementById(`${taskId}-role-select-div`).style.display = (assigneeType === 'role') ? 'block' : 'none';
    }

    function removeProjectTask(taskId) {
        const taskElement = document.getElementById(taskId);
        if (taskElement) {
            taskElement.remove();
        }
    }

    function submitProject() {
        const projectName = document.getElementById('project-name').value.trim();
        const projectDescription = document.getElementById('project-description').value.trim();
        
        if (!projectName) {
            alert('Please enter a project name.');
            return;
        }

        const projectTasksData = [];
        const taskEntries = document.querySelectorAll('#project-tasks-list .task-entry');

        if (taskEntries.length === 0) {
            alert('Please add at least one task to the project.');
            return;
        }

        let allTasksValid = true;
        taskEntries.forEach(taskEntry => {
            const taskId = taskEntry.id;
            const taskName = document.getElementById(`${taskId}-name`).value.trim();
            const taskDescription = document.getElementById(`${taskId}-description`).value.trim();
            const taskWeek = document.getElementById(`${taskId}-week`).value;
            const taskPriority = document.getElementById(`${taskId}-priority`).value;
            const assigneeType = document.getElementById(`${taskId}-assignee-type`).value;
            
            let assignedTo = '';
            if (assigneeType === 'user') {
                assignedTo = document.getElementById(`${taskId}-assignee-user`).value;
                if (!assignedTo) {
                    alert(`Please select a user for task "${taskName}".`);
                    allTasksValid = false;
                    return;
                }
            } else if (assigneeType === 'role') {
                assignedTo = document.getElementById(`${taskId}-assignee-role`).value;
                 if (!assignedTo) {
                    alert(`Please select a role for task "${taskName}".`);
                    allTasksValid = false;
                    return;
                }
            } else if (assigneeType === 'everyone') {
                assignedTo = 'everyone';
            }

            if (!taskName) {
                alert(`Task name cannot be empty for a task in project "${projectName}".`);
                allTasksValid = false;
                return;
            }

            projectTasksData.push({
                task_name: taskName,
                description: taskDescription,
                assigned_to_type: assigneeType, // new field to indicate if it's user/role/everyone
                assigned_to: assignedTo,
                priority: taskPriority,
                week_category: taskWeek // this_week, next_week, week_2, etc.
            });
        });

        if (!allTasksValid) {
            return; // Stop submission if any task is invalid
        }

        const projectData = {
            project_name: projectName,
            project_description: projectDescription,
            tasks: projectTasksData
        };

        fetch(`/create_project_with_tasks/${groupId}`, { // New Flask route needed
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeCreateProjectModal();
                location.reload();
            } else {
                alert('Failed to create project: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error creating project:', err);
            alert("Error creating project. Please check the console for details.");
        });
    }

    // --- NEW: Assign Existing Task Modal Functions ---
    function openAssignExistingTaskModal() {
        closeAssignTaskOptions(); // Close task options

        // Fetch all existing tasks and custom roles
        Promise.all([
            fetch(`/get_all_tasks/${groupId}`).then(res => res.json()), // New Flask route needed
            fetch(`/get_group_members_with_roles/${groupId}`).then(res => res.json())
        ])
        .then(([tasksData, rolesData]) => {
            if (tasksData.success && Array.isArray(tasksData.tasks)) {
                existingTasks = tasksData.tasks;
                populateExistingTasks(existingTasks);
            } else {
                alert('Failed to load existing tasks: ' + (tasksData.message || 'Unknown error'));
                console.error('Error loading existing tasks:', tasksData);
            }

            if (rolesData.success && Array.isArray(rolesData.available_custom_roles)) {
                availableCustomRoles = rolesData.available_custom_roles;
                populateAssignExistingTaskRoles(availableCustomRoles);
            } else {
                alert('Failed to load custom roles for assignment: ' + (rolesData.message || 'Unknown error'));
                console.error('Error loading custom roles:', rolesData);
            }

            document.getElementById('assignExistingTaskContainer').style.display = 'block';
            toggleAssignToSelection(); // Set initial visibility for assignee type
        })
        .catch(err => {
            console.error('Error fetching data for existing task assignment:', err);
            alert('Error loading data for task assignment.');
        });
    }

    function populateExistingTasks(tasks) {
        const selectTask = document.getElementById('select-existing-task');
        selectTask.innerHTML = '<option value="">-- Select an Existing Task --</option>';
        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.task_id; // Assuming tasks have a unique ID
                option.textContent = task.task_name;
                selectTask.appendChild(option);
            });
        }
    }

    function populateAssignExistingTaskRoles(roles) {
        const selectRole = document.getElementById('assign-task-to-role');
        selectRole.innerHTML = '';
        if (roles && roles.length > 0) {
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                selectRole.appendChild(option);
            });
        } else {
            selectRole.innerHTML = '<option value="">No custom roles available</option>';
        }
    }

    function toggleAssignToSelection() {
        const assignToType = document.getElementById('assign-task-to-type').value;
        document.getElementById('assign-task-user-selection').style.display = (assignToType === 'user') ? 'block' : 'none';
        document.getElementById('assign-task-role-selection').style.display = (assignToType === 'role') ? 'block' : 'none';
    }

    function closeAssignExistingTaskModal() {
        document.getElementById('assignExistingTaskContainer').style.display = 'none';
        document.getElementById('assignExistingTaskForm').reset();
        openAssignTaskOptions(); // Go back to task options
    }

    function submitAssignExistingTask() {
        const taskId = document.getElementById('select-existing-task').value;
        const assignToType = document.getElementById('assign-task-to-type').value;
        let assignedTo = '';

        if (!taskId) {
            alert('Please select an existing task.');
            return;
        }

        if (assignToType === 'user') {
            assignedTo = document.getElementById('assign-task-to-user').value;
            if (!assignedTo) {
                alert('Please select a user to assign the task to.');
                return;
            }
        } else if (assignToType === 'role') {
            assignedTo = document.getElementById('assign-task-to-role').value;
            if (!assignedTo) {
                alert('Please select a role to assign the task to.');
                return;
            }
        } else if (assignToType === 'everyone') {
            assignedTo = 'everyone';
        }

        const assignmentData = {
            task_id: taskId,
            assigned_to_type: assignToType,
            assigned_to: assignedTo
        };

        fetch(`/assign_existing_task/${groupId}`, { // New Flask route needed
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(assignmentData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeAssignExistingTaskModal();
                location.reload();
            } else {
                alert('Failed to assign task: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error assigning existing task:', err);
            alert('Error assigning existing task.');
        });
    }


    // Voice call functions (No change)
    function joinVoiceCall() {
        console.log("Joining voice call...");
        if (!client) {
            client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            client.join(APP_ID, CHANNEL, UID, async uid => {
                localTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await client.publish(localTrack);
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = false;
                console.log("Joined call as " + uid);
            }, err => {
                console.error("Join failed: ", err);
            });

            client.on("user-published", async (user, mediaType) => {
                await client.subscribe(user, mediaType);
                if (mediaType === "audio") {
                    user.audioTrack.play();
                }
            });

            client.on("user-unpublished", user => {
                console.log("User unpublished: ", user.uid);
            });
        }
    }

    function leaveVoiceCall() {
        console.log("Leaving voice call...");
        if (localTrack) {
            localTrack.close();
            localTrack = null;
        }
        if (client) {
            client.leave(() => {
                document.getElementById('joinBtn').disabled = false;
                document.getElementById('leaveBtn').disabled = true;
                console.log("Left call.");
            }, err => {
                console.error("Leave failed: ", err);
            });
            client = null;
        }
    }

    // UI functions (No change)
    function openWhiteboard() {
        const modal = document.getElementById('whiteboardModal');
        modal.style.display = 'flex';
        
        if (typeof initializeWhiteboard === 'function') {
            initializeWhiteboard();
        } else {
            console.error("initializeWhiteboard function not found");
        }
    }

    function closeWhiteboard() {
        document.getElementById('whiteboardModal').style.display = 'none';
    }

    function toggleTaskPanel() {
        const panel = document.getElementById('taskPanel');
        panel.classList.toggle('collapsed');
    }

    function toggleCollapsible(element) {
        element.classList.toggle('collapsed');
        const content = element.nextElementSibling;
        if (content.style.display === "block") {
            content.style.display = "none";
        } else {
            content.style.display = "block";
        }
    }

    window.onload = initAdminInterface;
    setInterval(fetchMessages, 5000);
</script>
</body>
</html>
