<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Collaboration Space</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='bundle.js') }}"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <style>
        /* Admin-specific styles */
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT PANEL: Navigation & Controls -->
        <div class="left-panel">
            <div class="buttons">
                <button onclick="openAssignTask()">Add Task</button>
                <button onclick="openApproveRequests()">Pending Requests</button>
                <button onclick="openRoleManagement()">Manage Roles</button>
                <a href="{{ url_for('dashboard', username=username) }}" class="styled-button">‚Üê</a>
            </div>

            <div class="chatbox">
                <div class="chatbox-header">
                    <span>Chat</span>
                    <button id="whiteboardToggleBtn">Show Whiteboard</button>
                </div>
                <div class="messages" id="messagesContainer"></div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
                    <button class="send-button" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <div class="voice-call-container">
                <h4>Voice Call</h4>
                <button id="joinBtn">Join Call</button>
                <button id="leaveBtn" disabled>Leave Call</button>
            </div>
        </div>
        
        <!-- RIGHT PANEL: Persistent Task Panel -->
        <div class="right-panel" id="taskPanel">
            <button class="panel-toggle" id="taskPanelToggle">‚â°</button>
            <div class="task-panel-content">
                <h3>Group Tasks</h3>
                
                <!-- DONE SECTION -->
                <div class="task-section">
                    <div class="collapsible">‚úÖ Done</div>
                    <ul id="done-tasks">
                        {% for task in completed_tasks %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No completed tasks</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- TO BE DONE THIS WEEK -->
                <div class="task-section">
                    <div class="collapsible">üéØ To Be Done This Week</div>
                    <ul id="this-week-tasks">
                        {% for task in tasks_this_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div>
                                <span style="font-weight: bold;">Deadline:</span> {{ task.deadline }}
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for this week</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- TASKS NEXT WEEK -->
                <div class="task-section">
                    <div class="collapsible">üóìÔ∏è Tasks Next Week</div>
                    <ul id="next-week-tasks">
                        {% for task in tasks_next_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for next week</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modals -->
    <div class="floating-container" id="approveRequestsContainer" style="display: none;">
        <h3>Pending Join Requests</h3>
        <ul id="pending-requests-list">
            {% for username in pending_requests %}
            <li>
                {{ username }}
                <form action="{{ url_for('approve_request', group_id=group_id, username=username) }}" method="post" style="display: inline;">
                    <button type="submit">Approve</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        <button onclick="closeApproveRequests()">Close</button>
    </div>

    <div class="floating-container" id="roleManagementContainer" style="display: none;">
        <h3>Manage Roles</h3>
        <div id="roleManagementContent">
        </div>
        <button onclick="closeRoleManagement()">Close</button>
    </div>

    <div class="floating-container" id="assignTaskContainer" style="display: none;">
        <h3>Assign Task</h3>
        <form id="assignTaskForm">
            <input type="text" id="task-name" placeholder="Task Name" required>
            <textarea id="task-description" placeholder="Task Description" rows="3"></textarea>
            <select id="assign-type" required>
                <option value="username">Assign to User</option>
                <option value="everyone">Assign to Everyone</option>
            </select>
            <select id="priority" required>
                <option value="High">High Priority</option>
                <option value="Medium">Medium Priority</option>
                <option value="Low">Low Priority</option>
            </select>
            <div id="user-selection">
                <select id="assigned-to" required>
                    {% for member in members %}
                    <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <br>
            <button type="button" id="assignTaskButton">Assign Task</button>
            <button type="button" class="cancel-button" onclick="closeAssignTask()">Cancel</button>
        </form>
    </div>

    <!-- Whiteboard Modal -->
    <div id="whiteboardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:8px; padding:20px; width:80%; max-width:800px; max-height:90vh; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Whiteboard</h3>
                <button onclick="closeWhiteboard()" style="background:#ff5555; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Close</button>
            </div>
            <canvas id="whiteboardCanvas" style="border:1px solid #ccc; background-color:white; width:100%; height:500px;"></canvas>
            <div style="text-align:center; margin-top:10px;">
                <button onclick="clearWhiteboard()" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Clear Whiteboard</button>
            </div>
        </div>
    </div>

    <script>
        // Admin credentials and API configuration
        const username = "{{ username }}";
        const groupId = "{{ group_id }}";
        const APP_ID = "8f0029e7fd2047339fe6822ab5b59abd";
        const CHANNEL = "{{ group_id }}";
        const UID = Math.floor(Math.random() * 10000);
        let client = null;
        let localTrack = null;

        // Initialize admin interface
        function initAdminInterface() {
            fetchMessages();
            initTaskAssignment();
            initCollapsibleSections();
            
            // Setup all event listeners
            document.getElementById('whiteboardToggleBtn').addEventListener('click', openWhiteboard);
            document.getElementById('assignTaskButton').addEventListener('click', assignTask);
            document.getElementById('assign-type').addEventListener('change', toggleUserSelection);
            document.getElementById('taskPanelToggle').addEventListener('click', toggleTaskPanel);
            document.getElementById('joinBtn').addEventListener('click', joinVoiceCall);
            document.getElementById('leaveBtn').addEventListener('click', leaveVoiceCall);
        }

        function initCollapsibleSections() {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.addEventListener('click', () => toggleCollapsible(el));
                el.classList.remove('collapsed');
                el.nextElementSibling.style.display = 'block';
            });
        }

        function initTaskAssignment() {
            const assignType = document.getElementById('assign-type');
            const userSelection = document.getElementById('user-selection');
            
            assignType.addEventListener('change', function() {
                userSelection.style.display = this.value === 'username' ? 'block' : 'none';
            });
        }

        // Message handling
        function fetchMessages() {
            // Same as in main.html
        }

        function sendMessage() {
            // Same as in main.html
        }

        // Task assignment
        function openAssignTask() {
            document.getElementById('assignTaskContainer').style.display = 'block';
        }

        function closeAssignTask() {
            document.getElementById('assignTaskContainer').style.display = 'none';
        }

        function assignTask() {
            const title = document.getElementById('task-name').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const assignType = document.getElementById('assign-type').value;
            const priority = document.getElementById('priority').value;
            let assignedTo = '';
            
            if (assignType === 'username') {
                assignedTo = document.getElementById('assigned-to').value.trim();
            } else if (assignType === 'everyone') {
                assignedTo = 'everyone';
            }
            
            if (title && priority) {
                fetch(`/assign_task/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'task_name': title,
                        'task_description': description,
                        'assigned_to': assignedTo,
                        'priority': priority,
                        'assigned_type': assignType
                    })
                })
                .then(res => res.text())
                .then(data => {
                    alert(data);
                    location.reload();
                })
                .catch(err => {
                    console.error(err);
                    alert("Error assigning task.");
                });
            } else {
                alert('Please fill all required fields.');
            }
        }

        // Role management
function openRoleManagement() {
    fetch(`/get_group_members_with_roles/${groupId}`) // NEW ENDPOINT
        .then(res => res.json())
        .then(data => {
            const content = document.getElementById('roleManagementContent');
            if (data.success && Array.isArray(data.members)) {
                let html = '<form id="roleForm">';
                data.members.forEach(user => {
                    // Display current primary role and allow changing it
                    html += `
                    <div>
                        <strong>${user.username}:</strong>
                        <select name="primary_role_${user.username}" data-username="${user.username}" onchange="updatePrimaryRole('${user.username}', this.value)">
                            <option value="admin" ${user.primary_role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="member" ${user.primary_role === 'member' ? 'selected' : ''}>Member</option>
                        </select>
                    </div>
                    `;
                    // Add section for custom roles
                    html += `
                    <div style="margin-left: 20px;">
                        Custom Roles:
                        <select multiple name="custom_roles_${user.username}" data-username="${user.username}" class="custom-role-select">
                            ${data.available_custom_roles.map(role => `
                                <option value="${role}" ${user.custom_roles.includes(role) ? 'selected' : ''}>${role}</option>
                            `).join('')}
                        </select>
                    </div>
                    `;
                });
                
                html += '<button type="button" onclick="saveRoles()">Save Roles</button>';
                html += '</form>';

                // Add section to create new custom roles
                html += `
                <hr>
                <h4>Create New Custom Role</h4>
                <input type="text" id="newRoleName" placeholder="New Role Name">
                <button type="button" onclick="createNewRole()">Create Role</button>
                `;

                content.innerHTML = html;
                document.getElementById('roleManagementContainer').style.display = 'block';
            } else {
                content.innerHTML = 'Error loading group members or roles.';
                console.error('Error from server:', data.message);
            }
        })
        .catch(err => {
            console.error('Error fetching group members:', err);
            document.getElementById('roleManagementContent').innerHTML = 'Error loading group members.';
        });
}

function createNewRole() {
    const newRoleName = document.getElementById('newRoleName').value.trim();
    if (!newRoleName) {
        alert('Please enter a role name.');
        return;
    }

    fetch(`/create_role/${groupId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role_name: newRoleName })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            openRoleManagement(); // Refresh the modal to show the new role
        } else {
            alert('Failed to create role: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error creating role:', err);
        alert('Error creating role.');
    });
}


    function closeRoleManagement() {
            document.getElementById('roleManagementContainer').style.display = 'none';
        }

function saveRoles() {
    const primaryRoleSelects = document.querySelectorAll('#roleForm select[name^="primary_role_"]');
    const customRoleSelects = document.querySelectorAll('#roleForm select[name^="custom_roles_"]');
    
    const updates = {}; // Object to hold all updates

    // Process primary role changes
    primaryRoleSelects.forEach(select => {
        const username = select.dataset.username;
        if (!updates[username]) updates[username] = {};
        updates[username]['primary_role'] = select.value;
    });

    // Process custom role changes
    customRoleSelects.forEach(select => {
        const username = select.dataset.username;
        if (!updates[username]) updates[username] = {};
        
        const selectedOptions = Array.from(select.selectedOptions).map(option => option.value);
        const allOptions = Array.from(select.options).map(option => option.value);

        const customRolesToAssign = selectedOptions.filter(role => !userHasRoleInitially(username, role)); // You'll need to store initial roles or refetch
        const customRolesToUnassign = allOptions.filter(role => !selectedOptions.includes(role) && userHasRoleInitially(username, role)); // Logic for what to remove

        // For simplicity in this example, we'll just send the full list and overwrite.
        // A more robust solution might track original state.
        updates[username]['custom_roles_to_assign'] = selectedOptions; // Send all selected for simplicity in this example
        updates[username]['custom_roles_to_unassign'] = allOptions.filter(role => !selectedOptions.includes(role)); // Send all unselected for simplicity

        // NOTE: The backend `update_roles` expects separate lists for 'to_assign' and 'to_unassign'.
        // This client-side code sends all selected as 'to_assign' and all unselected as 'to_unassign'.
        // The backend should correctly handle setting/deleting based on this.
    });

    fetch(`/update_roles/${groupId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Roles updated successfully!');
            closeRoleManagement();
            // Optionally, refresh mainadmin page to reflect changes
            location.reload(); 
        } else {
            alert('Failed to update roles: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Failed to update roles');
    });
}
        // Voice call functions (same as in main.html)
        function joinVoiceCall() {
            // Same as in main.html
        }

        function leaveVoiceCall() {
            // Same as in main.html
        }

        // UI functions
        function openWhiteboard() {
            const modal = document.getElementById('whiteboardModal');
            modal.style.display = 'flex';
            
            // Initialize the whiteboard when the modal is shown
            if (typeof initializeWhiteboard === 'function') {
                initializeWhiteboard();
            } else {
                console.error("initializeWhiteboard function not found");
            }
        }

        function closeWhiteboard() {
            // Same as in main.html
        }

        function toggleTaskPanel() {
            // Same as in main.html
        }

        function toggleCollapsible(element) {
            // Same as in main.html
        }

        // Set up the admin interface when page loads
        window.onload = initAdminInterface;
        setInterval(fetchMessages, 5000);  // Refresh messages every 5 seconds
    </script>
</body>
</html>
