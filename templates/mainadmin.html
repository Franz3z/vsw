<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Collaboration Space</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <script>
        // Global variables (declare only once)
    const username = "{{ username }}";
    const groupId = "{{ group_id }}";

        // Modal functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function openAssignModal() {
            showModal('assignModal');
            // Fetch and populate tasks in the modal
            fetch(`/get_all_tasks/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const taskSelect = document.getElementById('taskSelect');
                        taskSelect.innerHTML = '';
                        const allTasks = [
                            ...(data.tasks_this_week || []),
                            ...(data.tasks_next_week || []),
                            ...(data.completed_tasks || []),
                            ...(data.tasks_no_deadline || [])
                        ];
                        allTasks.forEach(task => {
                            const option = document.createElement('option');
                            option.value = task.task_id;
                            option.textContent = task.task_name;
                            taskSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching tasks:', error));
        }

        function openApproveRequests() {
            showModal('pendingRequestsModal');
            // Fetch pending requests
            fetch(`/get_pending_requests/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const requestsList = document.getElementById('pendingRequestsList');
                        requestsList.innerHTML = '';
                        data.pending_requests.forEach(request => {
                            const requestItem = document.createElement('div');
                            requestItem.className = 'pending-request-item';
                            requestItem.innerHTML = `
                                <span>${request.username}</span>
                                <div class="request-actions">
                                    <button onclick="approveRequest('${request.username}')">Approve</button>
                                    <button onclick="denyRequest('${request.username}')">Deny</button>
                                </div>
                            `;
                            requestsList.appendChild(requestItem);
                        });
                    }
                })
                .catch(error => console.error('Error fetching pending requests:', error));
        }

        function openSubmitModal() {
            showModal('submitProgressModalContainer');
        }

        function openCompletedTasksModal() {
            showModal('completedTasksModal');
            // Update completed tasks list here if needed
        }
    </script>
    </head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="buttons">
                <a href="{{ url_for('dashboard', username=username) }}" class="styled-button">‚Üê</a>
                <button onclick="openAssignModal()">Assign</button>
                <button onclick="openApproveRequests()">Pending Requests</button>
                <button onclick="openSubmitModal()">Submit Task</button>
                    <button onclick="openCompletedTasksModal()">Completed Tasks</button>
            </div>

            
    <div class="chatbox">
                <div class="chatbox-header">
                    <span>Chat</span>
                        <button id="whiteboardToggleBtn">Show Whiteboard</button>
                </div>
                <div class="messages" id="messagesContainer"></div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
                    <button class="send-button" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
            <script>
                // Message handling
               function fetchMessages() {
    console.log("Fetching messages...");
    fetch(`/get_messages/${groupId}`)
        .then(response => response.json())
        .then(data => {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = ''; // Clear existing messages

            data.messages.forEach(msg => { // Assuming Flask returns {'messages': [...]}
                const messageWrapper = document.createElement('div');
                const isSent = (msg.sender === username); // Assuming 'username' is the current user's username
                messageWrapper.classList.add('message-wrapper', isSent ? 'sent-message' : 'received-message');

                // Sender Name (only for received messages)
                if (!isSent) {
                    const senderNameElement = document.createElement('div');
                    senderNameElement.classList.add('sender-name');
                    senderNameElement.textContent = msg.sender;
                    messageWrapper.appendChild(senderNameElement);
                }

                // Message Bubble
                const msgBubble = document.createElement('div');
                msgBubble.classList.add('message-bubble');
                msgBubble.textContent = msg.message;
                messageWrapper.appendChild(msgBubble);

                // Timestamp
                const msgInfo = document.createElement('div');
                msgInfo.classList.add('message-info');
                msgInfo.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Format timestamp nicely
                messageWrapper.appendChild(msgInfo);

                messagesContainer.appendChild(messageWrapper);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => console.error('Error fetching messages:', error));
}
                function sendMessage() {
                    const text = document.getElementById('messageInput').value.trim();
                    if (!text) {
                        return;
                    }
                    fetch(`/send_message/${groupId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sender: username, text })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('messageInput').value = "";
                            fetchMessages();
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                    });
                }
    </script>

            
            <div class="voice-call-container">
                <h4>Voice Call</h4>
                <button id="joinBtn">Join Call</button>
                <button id="leaveBtn" disabled>Leave Call</button>
            </div>
        </div>
        
        <script>
            // Voice Call Functions
            async function joinVoiceCall() {
                if (!AgoraRTC.checkSystemRequirements()) {
                    alert("Your browser does not support WebRTC.");
                    return;
                }

                client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" });
                await client.join(APP_ID, CHANNEL, null, UID);
                localTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await client.publish(localTrack);

                document.getElementById('joinBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = false;

                client.on("user-published", async (user, mediaType) => {
                    if (mediaType === "audio") {
                        await client.subscribe(user, mediaType);
                        user.audioTrack.play();
                    }
                });
                console.log("Joined call.");
            }

            async function leaveVoiceCall() {
                if (localTrack) {
                    localTrack.close();
                    localTrack = null;
                }
                if (client) {
                    client.leave(() => {
                        document.getElementById('joinBtn').disabled = false;
                        document.getElementById('leaveBtn').disabled = true;
                        console.log("Left call.");
                    }, err => {
                        console.error("Leave failed: ", err);
                    });
                    client = null;
                }
            }
        </script>
            
        <div class="right-panel" id="taskPanel">
            <button class="panel-toggle" id="taskPanelToggle">‚â°</button>
            <div class="task-panel-content">
                <h3>Group Tasks</h3>
                <div class="task-section">
                    <div class="collapsible">üéØ To Be Done This Week</div>
                    <ul id="this-week-tasks"></ul>
                </div>

                <div class="task-section">
                    <div class="collapsible">üóìÔ∏è Tasks Next Week</div>
                    <ul id="next-week-tasks"></ul>
                </div>
            </div>
        </div>
        <script>
            function toggleTaskPanel() {
                const panel = document.getElementById('taskPanel');
                panel.classList.toggle('collapsed');
            }

            function initCollapsibleSections() {
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.addEventListener('click', () => toggleCollapsible(el));
                    // Initial state: ensure they are open by default on load, then allow collapsing
                    el.classList.remove('collapsed');
                    el.nextElementSibling.style.display = 'block';
                });
            }

            function toggleCollapsible(element) {
                element.classList.toggle('collapsed');
                const content = element.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            }
        </script>
    </div>

    <div id="pendingRequestsModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeApproveRequests()">√ó</button>
            <h3>Pending Join Requests</h3>
            <ul id="pending-requests-list">
                {# Initial content for pending requests will be loaded by JavaScript #}
            </ul>
        </div>
    </div>
    <script>
        async function openApproveRequests() {
            const pendingRequestsModal = document.getElementById('pendingRequestsModal');
            if (pendingRequestsModal) {
                pendingRequestsModal.style.display = 'flex';
            } else {
                console.error("Error: 'pendingRequestsModal' not found.");
                alert("Error: Pending requests modal not found. Please check HTML ID.");
                return;
            }

            if (!groupId) {
                alert('Group ID is missing. Cannot fetch pending requests.');
                return;
            }

            try {
                const response = await fetch(`/get_pending_requests/${groupId}`);
                const data = await response.json();

                const pendingRequestsList = document.getElementById('pending-requests-list');
                if (!pendingRequestsList) {
                    console.error("Error: 'pending-requests-list' not found.");
                    alert("Error: Pending requests list element not found. Please check HTML ID.");
                    return;
                }

                pendingRequestsList.innerHTML = ''; // Clear previous items

                if (data.success) {
                    if (data.pending_requests.length === 0) {
                        pendingRequestsList.innerHTML = '<li>No pending requests.</li>';
                    } else {
                        data.pending_requests.forEach(req => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                ${req.username}
                                <button type="button" class="approve-btn" onclick="handleRequestAction('${groupId}', '${req.username}', 'approve')">Approve</button>
                                <button type="button" class="decline-btn" onclick="handleRequestAction('${groupId}', '${req.username}', 'deny')">Deny</button>
                            `;
                            pendingRequestsList.appendChild(li);
                        });
                    }
                } else {
                    pendingRequestsList.innerHTML = `<li>Failed to load requests: ${data.message}</li>`;
                    alert('Failed to fetch pending requests: ' + data.message);
                }
            } catch (error) {
                console.error('Error fetching pending requests:', error);
                pendingRequestsList.innerHTML = '<li>Error loading requests. Please try again.</li>';
                alert('An error occurred while fetching pending requests.');
            }
        }

        async function handleRequestAction(groupId, username, actionType) {
            const url = actionType === 'approve'
                ? `/approve_request/${groupId}`
                : `/deny_request/${groupId}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({ username: username })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    openApproveRequests(); // Re-call to refresh the list
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Network or server error:', error);
                alert('An error occurred while processing your request.');
            }
        }

        function closeApproveRequests() {
            document.getElementById('pendingRequestsModal').style.display = 'none';
        }
    </script>

    <!-- Modal for Submitting Tasks and Files -->
    <div id="submitProgressModalContainer" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <h3 class="modal-header">Submit Progress</h3>
            <button class="modal-close-btn" onclick="closeSubmitModal()">&times;</button>
            <div class="modal-body">
                <p>Select a task and provide a progress report.</p>
                <select id="taskSelect" class="task-dropdown"></select>
                <form id="progressForm" onsubmit="submitProgress(event)">
                    <textarea id="progressText" name="progress" placeholder="Enter your progress notes..." required></textarea>
                    <input type="file" id="progressFile" name="file">
                    <small>Files are stored and served locally by the server.</small>
                    <button type="submit" class="submit-button">Submit Progress</button>
                </form>
            </div>
        </div>
    </div>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        fetchAndRenderTasksPanel();
        setInterval(fetchMessages, 5000);
        setInterval(fetchAndRenderTasksPanel, 30000);
    });

    function fetchAndRenderTasksPanel() {
        if (!groupId) {
            console.error('Group ID is not defined');
            return;
        }
        fetch(`/get_all_tasks/${groupId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Debug: log raw backend response
                console.log('Raw backend task data:', data);

                // Defensive: ensure all categories are arrays
                const allTasks = {
                    this_week: Array.isArray(data.tasks_this_week) ? data.tasks_this_week : (data.tasks_this_week ? [data.tasks_this_week] : []),
                    next_week: Array.isArray(data.tasks_next_week) ? data.tasks_next_week : (data.tasks_next_week ? [data.tasks_next_week] : []),
                    completed: Array.isArray(data.completed_tasks) ? data.completed_tasks : (data.completed_tasks ? [data.completed_tasks] : []),
                    no_deadline: Array.isArray(data.tasks_no_deadline) ? data.tasks_no_deadline : (data.tasks_no_deadline ? [data.tasks_no_deadline] : [])
                };

                // If all arrays are empty, show a warning
                const hasAnyTasks = Object.values(allTasks).some(arr => Array.isArray(arr) && arr.length > 0);
                if (!hasAnyTasks) {
                    const taskPanelContent = document.querySelector('.task-panel-content');
                    taskPanelContent.innerHTML = '<h3>Group Tasks</h3><div class="no-tasks">No tasks found in any category. Please check backend data.</div>';
                    return;
                }

                // Clear and rebuild the task panel content
                const taskPanelContent = document.querySelector('.task-panel-content');
                taskPanelContent.innerHTML = '<h3>Group Tasks</h3>';

                // Create and render only this week and next week sections
                const sections = [
                    { id: 'this-week-tasks', title: 'üéØ Tasks This Week', tasks: allTasks.this_week },
                    { id: 'next-week-tasks', title: 'üóìÔ∏è Tasks Next Week', tasks: allTasks.next_week }
                ];

                sections.forEach(section => {
                    const sectionHTML = `
                        <div class="task-section">
                            <div class="collapsible">${section.title}</div>
                            <ul id="${section.id}"></ul>
                        </div>
                    `;
                    taskPanelContent.insertAdjacentHTML('beforeend', sectionHTML);
                    // If tasks array is empty, show a message
                    if (!Array.isArray(section.tasks) || section.tasks.length === 0) {
                        const container = document.getElementById(section.id);
                        if (container) {
                            container.innerHTML = '<li class="no-tasks">No tasks available in this category.</li>';
                        }
                    } else {
                        renderTasksPanel(section.id, section.tasks);
                    }
                });

                // Reinitialize collapsible functionality
                initCollapsibleSections();
            })
            .catch(error => {
                console.error('Error fetching tasks for right panel:', error);
                const taskPanelContent = document.querySelector('.task-panel-content');
                if (taskPanelContent) {
                    taskPanelContent.innerHTML = `<h3>Group Tasks</h3><div class="error-message">Error loading tasks: ${error.message}</div>`;
                }
            });
    }

    function renderTasksPanel(containerId, tasks) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container element with ID '${containerId}' not found.`);
            return;
        }

        // Clear the container
        container.innerHTML = '';

        // Handle empty or invalid tasks array
        if (!Array.isArray(tasks) || tasks.length === 0) {
            container.innerHTML = `<li class="no-tasks">No tasks available.</li>`;
            return;
        }

        // Render each task
        tasks.forEach(task => {
            if (!task) return; // Skip null or undefined tasks
            
            const taskElement = document.createElement('li');
            taskElement.className = 'task-card';
            taskElement.innerHTML = `
                <div class="project-section">
                    <div class="project-name"><strong>Project:</strong> ${task.project_name || 'N/A'}</div>
                    <div class="project-description">${task.project_description || 'No project description.'}</div>
                </div>
                <div class="task-section">
                    <div class="task-title"><strong>Task:</strong> ${task.task_name || 'Untitled Task'}</div>
                    <div class="task-description">${task.description || 'No description provided.'}</div>
                </div>
                <div class="task-meta">
                    <div class="assignee-info">Assigned to: ${task.assigned_to || 'Unassigned'}</div>
                    <div class="deadline-info">Deadline: ${task.deadline || 'N/A'}</div>
                    <span class="priority-tag priority-${task.priority ? task.priority.toLowerCase() : 'normal'}">${task.priority || 'Normal'}</span>
                </div>
            `;
            container.appendChild(taskElement);
        });
    }

    // --- Submit Progress Modal ---
    function openSubmitModal() {
        const modal = document.getElementById('submitProgressModalContainer');
        if (!modal) return; // Robust check
        modal.style.display = 'flex';
        
        // Fetch tasks and populate the dropdown
        fetch(`/get_all_tasks/${groupId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Fetched tasks for submit modal:', data); // Debug log
                const taskSelect = document.getElementById('taskSelect');
                if (!taskSelect) return; // Robust check
                taskSelect.innerHTML = '';

                // Get all tasks assigned to the current user
                var tasksToReportOn = [];

                // Helper function to filter and add tasks
                const addTasksIfValid = (taskArray) => {
                    if (Array.isArray(taskArray)) {
                        const userTasks = taskArray.filter(task => 
                            task && 
                            task.assigned_to === username && 
                            task.status !== 'completed'
                        );
                        tasksToReportOn = tasksToReportOn.concat(userTasks);
                    }
                };

                // Add tasks from all relevant categories
                addTasksIfValid(data.tasks_this_week);
                addTasksIfValid(data.tasks_next_week);
                addTasksIfValid(data.tasks_no_deadline);
                
                // Sort tasks by deadline
                tasksToReportOn.sort((a, b) => {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });

                console.log('Filtered tasks to report on:', tasksToReportOn); // Debug log

                if (tasksToReportOn.length === 0) {
                    var opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No tasks assigned to you';
                    taskSelect.appendChild(opt);
                    return;
                }

                // Add tasks to dropdown
                tasksToReportOn.forEach(function(task) {
                    var option = document.createElement('option');
                    option.value = task.task_id;
                    
                    // Format the task name with all relevant information
                    const deadlineText = task.deadline ? ` (Due: ${task.deadline})` : '';
                    const projectText = task.project_name ? `[${task.project_name}] ` : '';
                    const statusText = task.status ? ` (${task.status})` : '';
                    
                    option.textContent = `${projectText}${task.task_name}${deadlineText}${statusText}`;
                    taskSelect.appendChild(option);
                });
            })
            .catch(function(error) {
                console.error('Error fetching tasks for progress modal:', error);
                alert('Could not load tasks for progress submission.');
            });
    }

    function closeSubmitModal() {
        const modal = document.getElementById('submitProgressModalContainer');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function submitProgress(event) {
        event.preventDefault();

        const taskSelect = document.getElementById('taskSelect');
        const taskId = taskSelect ? taskSelect.value : null;
        const progressText = document.getElementById('progressText');
        const fileInput = document.getElementById('progressFile');

        if (!taskId) {
            alert('Please select a task.');
            return;
        }

        if (!progressText || (!progressText.value && !fileInput.files[0])) {
            alert('Please provide some progress notes or a file.');
            return;
        }

        const formData = new FormData();
        formData.append('progress', progressText.value);
        // This is the new line of code that sets mark_completed to true
        formData.append('mark_completed', true);
        if (fileInput.files[0]) {
            formData.append('file', fileInput.files[0]);
        }

        const url = `/submit_progress/${username}/${groupId}/${taskId}`;
        
        fetch(url, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
            }
            return response.text();
        })
        .then(message => {
                alert('Progress submitted successfully!');
                closeSubmitModal();
                fetchAndRenderTasks();
        })
        .catch(error => {
            console.error('Error submitting progress:', error);
            alert(`An error occurred: ${error.message}`);
        });
    }

    // Function to create a new custom role
    function createNewRole() {
        const newRoleInput = document.getElementById('newRoleName');
        const roleName = newRoleInput.value.trim();
        
        if (!roleName) {
            alert('Please enter a role name');
            return;
        }

        // Disable the input and button while processing
        newRoleInput.disabled = true;
        const createButton = document.querySelector('button[onclick="createNewRole()"]');
        const originalText = createButton.textContent;
        createButton.disabled = true;
        createButton.textContent = 'Creating...';

        fetch(`/create_role/${groupId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                role_name: roleName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Role created successfully!');
                // Clear the input
                newRoleInput.value = '';
                // Refresh the role management panel
                openRoleManagement();
            } else {
                alert('Failed to create role: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating role:', error);
            alert('Error creating role. Please try again.');
        })
        .finally(() => {
            // Re-enable the input and button
            newRoleInput.disabled = false;
            createButton.disabled = false;
            createButton.textContent = originalText;
        });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', function() {
        fetchAndRenderTasksPanel();
        initCollapsibleSections();
    });
</script>
            
    <!-- Assign Modal -->
<div id="assignModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeAssignModal()">√ó</button>
        <div id="assignOptionsContainer">
            <h3>Assign Action</h3>
            <p>Please choose an action:</p>
            <button onclick="showAssignPanel('role')">Assign Role</button>
            <button onclick="showAssignPanel('task')">Assign Task</button>
        </div>

        <div id="assignRoleOptionsContainer" style="display: none;">
            <h3>Role Assignment Options</h3>
            <p>What role action do you want to perform?</p>
            <button onclick="openRoleManagement()">Manage & Create Roles</button>
            <button onclick="openAssignExistingRoleModal()">Assign Existing Role to Members</button>
            <button onclick="showAssignPanel('main')">‚Üê Back</button>
        </div>

        <div id="assignTaskOptionsContainer" style="display: none;">
            <h3>Task Assignment Options</h3>
            <p>Do you want to create a new project with tasks, or assign an existing task?</p>
            <button onclick="openCreateProjectModal()">Create Project</button>
            <button onclick="openAssignExistingTaskModal()">Assign Existing Task</button>
            <button type="button" class="cancel-button" onclick="showAssignPanel('main')">‚Üê Back</button>
        </div>

        <div id="roleManagementContainer" style="display: none;">
            <h3>Manage & Create Roles</h3>
            <div id="roleManagementContent"></div>
            <button onclick="showAssignPanel('role')">‚Üê Back</button>
        </div>

        <div id="assignExistingRoleContainer" style="display: none;">
            <h3>Assign Existing Role</h3>
            <form id="assignExistingRoleForm">
                <label for="select-role-to-assign">Select Role:</label>
                <select id="select-role-to-assign" required></select>
                <br>
                <label for="select-users-for-role">Select Users (Ctrl/Cmd + click to select multiple):</label>
                <select id="select-users-for-role" multiple required>
                    {% for member in members %}
                    <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
                <br>
                <button type="button" onclick="submitAssignExistingRole()">Assign Role</button>
                <button type="button" class="cancel-button" onclick="showAssignPanel('role')">‚Üê Back</button>
            </form>
        </div>

        <div id="createProjectContainer" style="display: none;">
            <h3>Create New Project</h3>
            <form id="createProjectForm">
                <label for="project-name">Project Name:</label>
                <input type="text" id="project-name" placeholder="Enter project name" required>
                <label for="project-description">Project Description:</label>
                <textarea id="project-description" placeholder="Describe the project" rows="3"></textarea>
                <label for="project-duration-weeks">Project Duration (weeks):</label>
                <input type="number" id="project-duration-weeks" min="1" placeholder="Number of weeks" style="width: 120px;">
                <h4>Project Tasks:</h4>
                <div id="project-tasks-list"></div>
                <button type="button" onclick="addProjectTask()">Add Task to Project</button>
                <br>
                <button type="button" onclick="submitProject()">Create Project with Tasks</button>
                <button type="button" class="cancel-button" onclick="showAssignPanel('task')">‚Üê Back</button>
            </form>
        </div>

        <div id="assignExistingTaskContainer" style="display: none;">
            <h3>Assign Existing Task</h3>
            <form id="assignExistingTaskForm">
                <label for="select-existing-task">Select Task:</label>
                <select id="select-existing-task" required></select>
                <br>
                <label for="assign-task-to-type">Assign To:</label>
                <select id="assign-task-to-type" onchange="toggleAssignToSelection()">
                    <option value="user">User</option>
                    <option value="role">Role</option>
                    <option value="everyone">Everyone</option>
                </select>
                <div id="assign-task-user-selection">
                    <label for="assign-task-to-user">Select User:</label>
                    <select id="assign-task-to-user">
                        {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="assign-task-role-selection" style="display: none;">
                    <label for="assign-task-to-role">Select Role:</label>
                    <select id="assign-task-to-role"></select>
                </div>
                <br>
                <button type="button" onclick="submitAssignExistingTask()">Assign Task</button>
                <button type="button" class="cancel-button" onclick="showAssignPanel('task')">‚Üê Back</button>
            </form>
        </div>
    </div>
</div>
<script>
// Assign Modal JS
let availableCustomRoles = [];
let projectIdCounter = 0;
let projectTasks = [];
let existingTasks = [];
function showAssignPanel(panelName) {
    document.getElementById('assignOptionsContainer').style.display = 'none';
    document.getElementById('assignRoleOptionsContainer').style.display = 'none';
    document.getElementById('assignTaskOptionsContainer').style.display = 'none';
    document.getElementById('assignExistingRoleContainer').style.display = 'none';
    document.getElementById('createProjectContainer').style.display = 'none';
    document.getElementById('assignExistingTaskContainer').style.display = 'none';
    document.getElementById('roleManagementContainer').style.display = 'none';
    switch(panelName) {
        case 'main':
            document.getElementById('assignOptionsContainer').style.display = 'block';
            break;
        case 'role':
            document.getElementById('assignRoleOptionsContainer').style.display = 'block';
            break;
        case 'task':
            document.getElementById('assignTaskOptionsContainer').style.display = 'block';
            break;
        case 'assignRole':
            document.getElementById('assignExistingRoleContainer').style.display = 'block';
            break;
        case 'createProject':
            document.getElementById('createProjectContainer').style.display = 'block';
            break;
        case 'assignTask':
            document.getElementById('assignExistingTaskContainer').style.display = 'block';
            break;
        case 'manageRoles':
            document.getElementById('roleManagementContainer').style.display = 'block';
            break;
        default:
            document.getElementById('assignOptionsContainer').style.display = 'block';
            break;
    }
}
function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
    const assignExistingRoleForm = document.getElementById('assignExistingRoleForm');
    if (assignExistingRoleForm) assignExistingRoleForm.reset();
    const createProjectForm = document.getElementById('createProjectForm');
    if (createProjectForm) createProjectForm.reset();
    const assignExistingTaskForm = document.getElementById('assignExistingTaskForm');
    if (assignExistingTaskForm) assignExistingTaskForm.reset();
}

// --- Assign Existing Role Modal Functions ---
function openAssignExistingRoleModal() {
    showAssignPanel('assignRole');
    // First populate roles
    populateRoleSelection();
    // Then fetch and populate users with roles
    fetch(`/get_group_members_with_roles/${groupId}`)
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.json();
        })
        .then(data => {
            const userSelect = document.getElementById('select-users-for-role');
            userSelect.innerHTML = '';
            if (data.success && Array.isArray(data.members) && data.members.length > 0) {
                data.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.username;
                    let rolesText = '';
                    if (member.primary_role) {
                        rolesText += `[${member.primary_role}]`;
                    }
                    if (Array.isArray(member.custom_roles) && member.custom_roles.length > 0) {
                        rolesText += ` (${member.custom_roles.join(', ')})`;
                    }
                    option.textContent = `${member.username} ${rolesText}`;
                    userSelect.appendChild(option);
                });
            } else {
                userSelect.innerHTML = '<option value="">No members available</option>';
            }
        })
        .catch(error => {
            console.error('Error fetching members:', error.message || error);
            const userSelect = document.getElementById('select-users-for-role');
            if (userSelect) {
                userSelect.innerHTML = '<option value="">Error loading members</option>';
            }
        });
}

function populateRoleSelection() {
    // Fetch available roles from the server
    fetch(`/get_available_roles/${groupId}`)
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                throw new Error('No data received');
            }

            const roles = data.available_roles || [];
            const selectRole = document.getElementById('select-role-to-assign');
            if (selectRole) {
                selectRole.innerHTML = '<option value="">-- Select a Role --</option>';
                roles.forEach(role => {
                    if (role) {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        selectRole.appendChild(option);
                    }
                });
            }

            // Also update the global availableCustomRoles array
            availableCustomRoles = roles;
        })
        .catch(error => {
            console.error('Error fetching roles:', error);
            // Set a default empty state for the dropdowns
            const selectRole = document.getElementById('select-role-to-assign');
            if (selectRole) {
                selectRole.innerHTML = '<option value="">No roles available</option>';
            }
        });
}

function submitAssignExistingRole() {
    const selectedRole = document.getElementById('select-role-to-assign').value;
    const selectedUsersElement = document.getElementById('select-users-for-role');
    const selectedUsers = Array.from(selectedUsersElement.selectedOptions).map(option => option.value);

    if (!selectedRole) { alert('Please select a role.'); return; }
    if (selectedUsers.length === 0) { alert('Please select at least one user.'); return; }

    // Build updates payload for backend
    const updates = {};
    selectedUsers.forEach(user => {
        updates[user] = {
            custom_roles_to_assign: [selectedRole],
            username: user
        };
    });

    // Show loading state
    const submitButton = document.querySelector('#assignExistingRoleForm button[type="button"]');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Assigning...';

    fetch(`/update_roles/${groupId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
    })
    .then(res => res.json())
    .then(data => {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
        if (data.success) {
            alert(data.message || 'Role assigned successfully!');
            showAssignPanel('role');
            location.reload();
        } else {
            alert('Failed to assign role: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(err => {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
        console.error('Error assigning role:', err);
        alert('Error assigning role. Please try again.');
    });
}

// --- Role Management Functions ---
function openRoleManagement() {
    showAssignPanel('manageRoles');
    fetch(`/get_group_members_with_roles/${groupId}`)
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => { throw new Error(text); });
            }
            return res.json();
        })
        .then(data => {
            const content = document.getElementById('roleManagementContent');
            // Defensive: ensure members and available_custom_roles are arrays
            const members = Array.isArray(data.members) ? data.members : [];
            const availableCustomRoles = Array.isArray(data.available_custom_roles) ? data.available_custom_roles : [];
            let html = '';
            if (data && data.success) {
                html += '<form id="roleForm">';
                if (members.length > 0) {
                    members.forEach(user => {
                        html += `
                        <div>
                            <strong>${user.username || ''}:</strong>
                            <select name="primary_role_${user.username || ''}" data-username="${user.username || ''}">
                                <option value="admin" ${(user.primary_role === 'admin') ? 'selected' : ''}>Admin</option>
                                <option value="member" ${(user.primary_role === 'member') ? 'selected' : ''}>Member</option>
                            </select>
                        </div>
                        <div style="margin-left: 20px;">
                            Custom Roles:
                            <select multiple name="custom_roles_${user.username || ''}" data-username="${user.username || ''}" class="custom-role-select">
                                ${availableCustomRoles.map(role => `
                                    <option value="${role}" ${(Array.isArray(user.custom_roles) && user.custom_roles.includes(role)) ? 'selected' : ''}>${role}</option>
                                `).join('')}
                            </select>
                        </div>
                        `;
                    });
                } else {
                    html += '<div class="no-members">No members found in this group.</div>';
                }
                html += '<button type="button" onclick="saveRoles()">Save Roles</button>';
                html += '</form>';

                html += `
                <hr>
                <h4>Create New Custom Role</h4>
                <input type="text" id="newRoleName" placeholder="New Role Name">
                <button type="button" onclick="createNewRole()">Create Role</button>
                `;

                html += `
                <hr>
                <h4>Remove Custom Role</h4>
                <select id="roleToDelete">
                    <option value="">-- Select Role to Remove --</option>
                    ${availableCustomRoles.length > 0 ? availableCustomRoles.map(role => `
                        <option value="${role}">${role}</option>
                    `).join('') : '<option value="">No roles available</option>'}
                </select>
                <button type="button" class="cancel-button" onclick="deleteCustomRole()">Remove Role</button>
                `;

                content.innerHTML = html;
            } else {
                // Show backend error message if available
                let errorMsg = 'No members or roles found.';
                if (data && data.message) {
                    errorMsg += ` Backend message: ${data.message}`;
                }
                content.innerHTML = `<p class="error-message">${errorMsg}</p>`;
            }
        })
        .catch(err => {
            console.error('Error fetching group members (role management):', err);
            const content = document.getElementById('roleManagementContent');
            content.innerHTML = `<p class="error-message">Error loading role management data. Please try again later.</p>`;
        });
}

// --- NEW: Create Project Modal Functions ---
function openCreateProjectModal() {
    showAssignPanel('createProject');
    document.getElementById('createProjectForm').reset();
    document.getElementById('project-tasks-list').innerHTML = '';
    projectTasks = [];
    projectIdCounter = 0;
}

function addProjectTask() {
    const tasksList = document.getElementById('project-tasks-list');
    const taskId = `task-${projectIdCounter++}`;

    const taskEntryDiv = document.createElement('div');
    taskEntryDiv.className = 'task-entry';
    taskEntryDiv.id = taskId;
    // Get project duration from input
    const durationInput = document.getElementById('project-duration-weeks');
    let durationWeeks = parseInt(durationInput && durationInput.value ? durationInput.value : '2');
    if (isNaN(durationWeeks) || durationWeeks < 1) durationWeeks = 2;
    let weekOptions = '<option value="this_week">This Week</option><option value="next_week">Next Week</option>';
    for (let i = 2; i <= durationWeeks; i++) {
        weekOptions += `<option value="week_${i}">Week ${i}</option>`;
    }
    taskEntryDiv.innerHTML = `
        <h5>Task #${projectIdCounter}</h5>
        <label for="${taskId}-name">Task Name:</label>
        <input type="text" id="${taskId}-name" placeholder="Task Name" required>

        <label for="${taskId}-description">Description:</label>
        <textarea id="${taskId}-description" placeholder="Task Description" rows="2"></textarea>

        <label for="${taskId}-week">Assign to Week:</label>
        <select id="${taskId}-week">${weekOptions}</select>

        <label for="${taskId}-priority">Priority:</label>
        <select id="${taskId}-priority">
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>

        <label for="${taskId}-assignee-type">Assign To:</label>
        <select id="${taskId}-assignee-type" onchange="toggleProjectTaskAssignee('${taskId}')">
            <option value="user">Specific User</option>
            <option value="role">Role</option>
            <option value="everyone">Everyone in Group</option>
        </select>

        <div id="${taskId}-user-select-div">
            <label for="${taskId}-assignee-user">Select User:</label>
            <select id="${taskId}-assignee-user">
                {% for member in members %}
                <option value="{{ member.username }}">{{ member.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="${taskId}-role-select-div" style="display:none;">
            <label for="${taskId}-assignee-role">Select Role:</label>
            <select id="assign-task-to-role"></select>
        </div>

        <button type="button" class="cancel-button" onclick="removeProjectTask('${taskId}')">Remove Task</button>
    `;
    tasksList.appendChild(taskEntryDiv);

    populateProjectTaskRoles(taskId);
    toggleProjectTaskAssignee(taskId);
}

function populateProjectTaskRoles(taskId) {
    const selectRole = document.getElementById(`${taskId}-assignee-role`);
    selectRole.innerHTML = '';
    if (availableCustomRoles && availableCustomRoles.length > 0) {
        availableCustomRoles.forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            selectRole.appendChild(option);
        });
    } else {
        selectRole.innerHTML = '<option value="">No custom roles available</option>';
    }
}

function removeProjectTask(taskId) {
    const taskEntry = document.getElementById(taskId);
    if (taskEntry) {
        taskEntry.remove();
    }
}

function toggleProjectTaskAssignee(taskId) {
    const assigneeType = document.getElementById(`${taskId}-assignee-type`).value;
    const userSelectDiv = document.getElementById(`${taskId}-user-select-div`);
    const roleSelectDiv = document.getElementById(`${taskId}-role-select-div`);

    userSelectDiv.style.display = 'none';
    roleSelectDiv.style.display = 'none';

    if (assigneeType === 'user') {
        userSelectDiv.style.display = 'block';
    } else if (assigneeType === 'role') {
        roleSelectDiv.style.display = 'block';
    }
}

// CORRECTED: submitProject function
function submitProject() {
    const projectName = document.getElementById('project-name').value.trim();
    const projectDescription = document.getElementById('project-description').value.trim();
    const projectDurationWeeks = document.getElementById('project-duration-weeks').value;
    if (!projectName) { alert('Please enter a project name.'); return; }

    const taskForms = document.querySelectorAll('.task-entry');
    if (taskForms.length === 0) { alert('Please add at least one task to the project.'); return; }

    const tasks = [];
    let allTasksValid = true;
    taskForms.forEach(taskForm => {
        const taskId = taskForm.id;
        const taskName = document.getElementById(`${taskId}-name`).value.trim();
        const taskDescription = document.getElementById(`${taskId}-description`).value.trim();
        const weekValue = document.getElementById(`${taskId}-week`).value;
        const taskPriority = document.getElementById(`${taskId}-priority`).value;
        const assigneeType = document.getElementById(`${taskId}-assignee-type`).value;
        let assignedTo = '';

        if (assigneeType === 'user') {
            assignedTo = document.getElementById(`${taskId}-assignee-user`).value;
        } else if (assigneeType === 'role') {
            assignedTo = document.getElementById(`${taskId}-assignee-role`).value;
        } else if (assigneeType === 'everyone') {
            assignedTo = 'everyone';
        }

        if (taskName && weekValue && (assignedTo || assigneeType === 'everyone')) {
            const today = new Date();
            const selectedWeek = parseInt(weekValue);
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const deadline = new Date(startOfWeek);
            deadline.setDate(startOfWeek.getDate() + (selectedWeek * 7) + 6);
            const deadlineStr = deadline.getFullYear() + '-' + 
                String(deadline.getMonth() + 1).padStart(2, '0') + '-' + 
                String(deadline.getDate()).padStart(2, '0');

            tasks.push({
                task_name: taskName,
                description: taskDescription,
                week: weekValue,
                priority: taskPriority,
                assigned_to_type: assigneeType,
                assigned_to: assignedTo,
                deadline: deadlineStr
            });
        } else {
            alert('Please fill in all task details and select an assignee for each task.');
            allTasksValid = false;
            return;
        }
    });

    if (!allTasksValid) { return; }

    const projectData = {
        project_name: projectName,
        description: projectDescription,
        duration_weeks: projectDurationWeeks,
        tasks: tasks
    };

    fetch(`/create_project_with_tasks/${groupId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(projectData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Project and tasks created successfully!');
            closeAssignModal();
            location.reload();
        } else {
            alert('Failed to create project: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error creating project:', err);
        alert('Error creating project.');
    });
}

// --- Assign Existing Task Modal Functions ---
function openAssignExistingTaskModal() {
    fetch(`/get_all_tasks/${groupId}`)
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => { throw new Error(text); });
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                // Combine all tasks from all categories
                const allTasks = [
                    ...(data.tasks_this_week || []),
                    ...(data.tasks_next_week || []),
                    ...(data.completed_tasks || []),
                    ...(data.tasks_no_deadline || [])
                ];
                existingTasks = allTasks;
                populateExistingTaskSelection(existingTasks);
                populateExistingTaskRoleSelection();
                showAssignPanel('assignTask');
            } else {
                console.error('Failed to fetch available tasks:', data.message);
                alert('Failed to load tasks. ' + (data.message || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Error fetching tasks:', err.message || err);
            alert('Error loading tasks.');
        });
}

function populateExistingTaskSelection(tasks) {
    const selectTask = document.getElementById('select-existing-task');
    selectTask.innerHTML = '<option value="">-- Select a Task --</option>';
    if (tasks && tasks.length > 0) {
        tasks.forEach(task => {
            const option = document.createElement('option');
            option.value = task.task_id;
            option.textContent = task.task_name;
            selectTask.appendChild(option);
        });
    }
}

function populateExistingTaskRoleSelection() {
    const selectRole = document.getElementById('assign-task-to-role');
    if (!selectRole) return;

    selectRole.innerHTML = '<option value="">-- Select a Role --</option>';
    
    // Use global availableCustomRoles if available
    if (Array.isArray(availableCustomRoles) && availableCustomRoles.length > 0) {
        availableCustomRoles.forEach(role => {
            if (role) {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                selectRole.appendChild(option);
            }
        });
    } else {
        // If no roles available, try to fetch them
        fetch(`/get_available_roles/${groupId}`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server error: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data) {
                    throw new Error('No data received');
                }
                const roles = data.available_roles || [];
                availableCustomRoles = roles; // Update global variable
                
                if (roles.length > 0) {
                    roles.forEach(role => {
                        if (role) {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role;
                            selectRole.appendChild(option);
                        }
                    });
                } else {
                    selectRole.innerHTML = '<option value="">No roles available</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching roles:', error);
                selectRole.innerHTML = '<option value="">Error loading roles</option>';
            });
    }
}

function toggleAssignToSelection() {
    const assigneeType = document.getElementById('assign-task-to-type').value;
    const userSelectDiv = document.getElementById('assign-task-user-selection');
    const roleSelectDiv = document.getElementById('assign-task-role-selection');
    userSelectDiv.style.display = assigneeType === 'user' ? 'block' : 'none';
    roleSelectDiv.style.display = assigneeType === 'role' ? 'block' : 'none';
}

// CORRECTED: submitAssignExistingTask function
function submitAssignExistingTask() {
    const taskId = document.getElementById('select-existing-task').value;
    const assigneeType = document.getElementById('assign-task-to-type').value;
    let assignedTo = '';

    if (!taskId) { alert('Please select a task.'); return; }

    if (assigneeType === 'user') {
        assignedTo = document.getElementById('assign-task-to-user').value;
    } else if (assigneeType === 'role') {
        assignedTo = document.getElementById('assign-task-to-role').value;
    } else if (assigneeType === 'everyone') {
        assignedTo = 'everyone';
    }

    if (!assignedTo && assigneeType !== 'everyone') {
        alert('Please select an assignee.');
        return;
    }

    fetch(`/assign_existing_task/${groupId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            task_id: taskId,
            assigned_to_type: assigneeType,
            assigned_to: assignedTo
        })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        if (data.success) {
            alert('Task assigned successfully!');
            closeAssignModal();
            location.reload();
        } else {
            alert('Failed to assign task: ' + data.message);
        }
    })
    .catch(function(err) {
        console.error('Error assigning task:', err);
        alert('Error assigning task.');
    });
}
    </script>

  <div id="whiteboardModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div
        style="background:white; border-radius:8px; padding:20px; width:80%; max-width:800px; max-height:90vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Whiteboard</h3>
            <button id="closeWhiteboardBtn"
                style="background:#ff5555; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Close</button>
        </div>
        <canvas id="whiteboardCanvas"
            style="border:1px solid #ccc; background-color:white; width:100%; height:500px;"></canvas>
        <div style="text-align:center; margin-top:10px;">
            <button id="clearWhiteboardBtn"
                style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Clear
                Whiteboard</button>
        </div>
    </div>
</div>

    <script>
        // Admin credentials and API configuration (global constants)
        const APP_ID = "8f0029e7fd2047339fe6822ab5b59abd";
        const CHANNEL = "{{ group_id }}";
        const UID = Math.floor(Math.random() * 10000);
        let client = null; // Agora client for voice calls
        let localTrack = null; // Agora local audio track

        // Initialize admin interface
        function initAdminInterface() {
            fetchMessages(); // From chatbox script
            initCollapsibleSections(); // From task panel script

            // Setup all event listeners (buttons in the left panel)
            document.getElementById('whiteboardToggleBtn').addEventListener('click', openWhiteboard);
            document.getElementById('taskPanelToggle').addEventListener('click', toggleTaskPanel);
            document.getElementById('joinBtn').addEventListener('click', joinVoiceCall);
            document.getElementById('leaveBtn').addEventListener('click', leaveVoiceCall);
        }

        // Global event listeners and intervals
        window.onload = initAdminInterface;
        setInterval(fetchMessages, 5000); // Fetch messages every 5 seconds

    // --- Completed Tasks Modal ---
    function openCompletedTasksModal() {
        const modal = document.getElementById('completedTasksModal');
        if (!modal) return;
        modal.style.display = 'flex';
        // Fetch completed tasks and render them in the modal
        fetch(`/get_tasks/${groupId}`)
            .then(response => response.json())
            .then(data => {
                const completedTasks = data.completed_tasks || [];
                const body = document.getElementById('completedTasksModalBody');
                if (!body) return;
                if (completedTasks.length === 0) {
                    body.innerHTML = '<p>No completed tasks.</p>';
                    return;
                }
                body.innerHTML = '';
                completedTasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task-card';
                    let fileUrl = null;
                    // Prefer main file, else first progress file
                    if (task.file_url) {
                        fileUrl = task.file_url;
                    } else if (task.progress_reports) {
                        for (const report of Object.values(task.progress_reports)) {
                            if (report.file_url) {
                                fileUrl = report.file_url;
                                break;
                            }
                        }
                    }
                    let fileSection = '';
                    if (fileUrl) {
                        fileSection = `<a href="${fileUrl}" target="_blank" class="open-btn">Open File</a>`;
                    }
                    taskDiv.innerHTML = `
                        <h4>${task.task_name}</h4>
                        <p>${task.description}</p>
                        <p><strong>Assigned to:</strong> ${task.assigned_to}</p>
                        <p><strong>Priority:</strong> <span class="priority-${task.priority ? task.priority.toLowerCase() : ''}">${task.priority || ''}</span></p>
                        <p><strong>Deadline:</strong> ${task.deadline || 'N/A'}</p>
                        ${fileSection}
                    `;
                    body.appendChild(taskDiv);
                });
            })
            .catch(error => {
                const body = document.getElementById('completedTasksModalBody');
                if (body) body.innerHTML = `<p class="error-message">Error loading completed tasks: ${error.message}</p>`;
            });
    }
    </script>

    <script type="module" src="/static/bundle.js"></script>
    <div id="completedTasksModal" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <h3>Completed Tasks</h3>
            <button type="button" class="modal-close-btn" onclick="hideModal('completedTasksModal')">&#215;</button>
            <div id="completedTasksModalBody">
                <!-- Completed tasks will be rendered here by JS -->
            </div>
        </div>
    </div>
</body>
</html>
