<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Collaboration Space</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='bundle.js') }}"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <style>
        /* Admin-specific styles */
    </style>
</head>
<body>
    <!-- Admin layout and UI elements -->
    
    <!-- Admin modals (assign task, manage roles, etc.) -->

    <script>
        // Admin credentials and API configuration
        const username = "{{ username }}";
        const groupId = "{{ group_id }}";
        const APP_ID = "8f0029e7fd2047339fe6822ab5b59abd";
        const CHANNEL = "{{ group_id }}";
        const UID = Math.floor(Math.random() * 10000);
        let client = null;
        let localTrack = null;

        // Initialize admin interface
        function initAdminInterface() {
            fetchMessages();
            initTaskAssignment();
            initCollapsibleSections();
            
            // Setup all event listeners
            document.getElementById('whiteboardToggleBtn').addEventListener('click', openWhiteboard);
            document.getElementById('assignTaskButton').addEventListener('click', assignTask);
            document.getElementById('assign-type').addEventListener('change', toggleUserSelection);
            document.getElementById('taskPanelToggle').addEventListener('click', toggleTaskPanel);
            document.getElementById('joinBtn').addEventListener('click', joinVoiceCall);
            document.getElementById('leaveBtn').addEventListener('click', leaveVoiceCall);
        }

        function initCollapsibleSections() {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.addEventListener('click', () => toggleCollapsible(el));
                el.classList.remove('collapsed');
                el.nextElementSibling.style.display = 'block';
            });
        }

        function initTaskAssignment() {
            const assignType = document.getElementById('assign-type');
            const userSelection = document.getElementById('user-selection');
            
            assignType.addEventListener('change', function() {
                userSelection.style.display = this.value === 'username' ? 'block' : 'none';
            });
        }

        // Message handling
        function fetchMessages() {
            // Same as in main.html
        }

        function sendMessage() {
            // Same as in main.html
        }

        // Task assignment
        function openAssignTask() {
            document.getElementById('assignTaskContainer').style.display = 'block';
        }

        function closeAssignTask() {
            document.getElementById('assignTaskContainer').style.display = 'none';
        }

        function assignTask() {
            const title = document.getElementById('task-name').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const assignType = document.getElementById('assign-type').value;
            const priority = document.getElementById('priority').value;
            let assignedTo = '';
            
            if (assignType === 'username') {
                assignedTo = document.getElementById('assigned-to').value.trim();
            } else if (assignType === 'everyone') {
                assignedTo = 'everyone';
            }
            
            if (title && priority) {
                fetch(`/assign_task/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'task_name': title,
                        'task_description': description,
                        'assigned_to': assignedTo,
                        'priority': priority,
                        'assigned_type': assignType
                    })
                })
                .then(res => res.text())
                .then(data => {
                    alert(data);
                    location.reload();
                })
                .catch(err => {
                    console.error(err);
                    alert("Error assigning task.");
                });
            } else {
                alert('Please fill all required fields.');
            }
        }

        // Role management
        function openRoleManagement() {
            fetch(`/get_group_members/${groupId}`)
                .then(res => res.json())
                .then(members => {
                    const content = document.getElementById('roleManagementContent');
                    
                    if (Array.isArray(members)) {
                        let html = '<form id="roleForm">';
                        
                        members.forEach(user => {
                            html += `
                            <div>
                                ${user.username}:
                                <select name="role_${user.username}">
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="member" ${user.role === 'member' ? 'selected' : ''}>Member</option>
                                </select>
                            </div>
                            `;
                        });
                        
                        html += '<button type="button" onclick="saveRoles()">Save Roles</button></form>';
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = 'Error loading group members';
                    }
                    
                    document.getElementById('roleManagementContainer').style.display = 'block';
                })
                .catch(err => {
                    console.error('Error fetching group members:', err);
                    document.getElementById('roleManagementContent').innerHTML = 'Error loading group members';
                });
        }

        function closeRoleManagement() {
            document.getElementById('roleManagementContainer').style.display = 'none';
        }

        function saveRoles() {
            const selects = document.querySelectorAll('#roleForm select');
            const roles = {};
            
            selects.forEach(select => {
                const username = select.name.replace('role_', '');
                roles[username] = select.value;
            });
            
            fetch(`/update_roles/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(roles)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Roles updated successfully!');
                    closeRoleManagement();
                } else {
                    alert('Failed to update roles: ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Failed to update roles');
            });
        }

        // Voice call functions (same as in main.html)
        function joinVoiceCall() {
            // Same as in main.html
        }

        function leaveVoiceCall() {
            // Same as in main.html
        }

        // UI functions (same as in main.html)
        function openWhiteboard() {
            // Same as in main.html
        }

        function closeWhiteboard() {
            // Same as in main.html
        }

        function toggleTaskPanel() {
            // Same as in main.html
        }

        function toggleCollapsible(element) {
            // Same as in main.html
        }

        // Set up the admin interface when page loads
        window.onload = initAdminInterface;
        setInterval(fetchMessages, 5000);  // Refresh messages every 5 seconds
    </script>
</body>
</html>
