<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Collaboration Space</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='bundle.js') }}"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="buttons">
                <a href="{{ url_for('dashboard', username=username) }}" class="styled-button">‚Üê</a>
            </div>

            <div class="chatbox">
                <div class="chatbox-header">
                    <span>Chat</span>
                    <button id="whiteboardToggleBtn">Show Whiteboard</button>
                </div>
                <div class="messages" id="messagesContainer"></div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
                    <button class="send-button" onclick="sendMessage()">Send</button>
                </div>
            </div>
            <script>
                // Mesfuncsage handling
                function fetchMessages() {
                    console.log("Fetching messages...");
                    fetch(`/get_messages/${groupId}`)
                        .then(response => response.json())
                        .then(data => {
                            const messagesContainer = document.getElementById('messagesContainer');
                            messagesContainer.innerHTML = '';
                            data.messages.forEach(msg => {
                                const msgElement = document.createElement('p');
                                msgElement.textContent = `${msg.timestamp} - ${msg.sender}: ${msg.message}`;
                                messagesContainer.appendChild(msgElement);
                            });
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        })
                        .catch(error => console.error('Error fetching messages:', error));
                }

                function sendMessage() {
                    // Get the message text from the input field and remove leading/trailing whitespace
                    const text = document.getElementById('messageInput').value.trim();

                    // If the message is empty after trimming, do nothing
                    if (!text) {
                        return;
                    }

                    // Send a POST request to the server to save the message
                    fetch(`/send_message/${groupId}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                sender: username,
                                text
                            })
                        })
                        .then(res => res.json()) // Parse the JSON response from the server
                        .then(data => {
                            // If the message was sent successfully
                            if (data.success) {
                                // Clear the message input field
                                document.getElementById('messageInput').value = "";
                                // Immediately fetch the messages to show the new one
                                fetchMessages();
                            }
                        })
                        .catch(error => {
                            // Log any errors that occur during the fetch
                            console.error('Error sending message:', error);
                        });
                }
            </script>

            <div class="voice-call-container">
                <h4>Voice Call</h4>
                <button id="joinBtn">Join Call</button>
                <button id="leaveBtn" disabled>Leave Call</button>
            </div>
            <script>
                // Voice call functions
                function joinVoiceCall() {
                    client = AgoraRTC.createClient({
                        mode: "rtc",
                        codec: "vp8"
                    });

                    client.on("user-published", async (user, mediaType) => {
                        await client.subscribe(user, mediaType);
                        if (mediaType === "audio") {
                            user.audioTrack.play();
                        }
                    });

                    client.on("user-unpublished", () => {});

                    client.join(APP_ID, CHANNEL, null, UID)
                        .then(() => {
                            return AgoraRTC.createMicrophoneAudioTrack();
                        })
                        .then(track => {
                            localTrack = track;
                            client.publish([localTrack]);
                            document.getElementById("joinBtn").disabled = true;
                            document.getElementById("leaveBtn").disabled = false;
                        })
                        .catch(err => {
                            console.error("Failed to join channel:", err);
                            alert("Error joining the call: " + err.message);
                        });
                }

                function leaveVoiceCall() {
                    if (localTrack) {
                        localTrack.stop();
                        localTrack.close();
                    }

                    if (client) {
                        client.leave()
                            .then(() => {
                                document.getElementById("joinBtn").disabled = false;
                                document.getElementById("leaveBtn").disabled = true;
                            });
                    }
                }
            </script>
        </div>

        <div class="right-panel" id="taskPanel">
            <button class="panel-toggle" id="taskPanelToggle">‚â°</button>
            <div class="task-panel-content">
                <h3>Group Tasks</h3>

                <div class="task-section">
                    <div class="collapsible">‚úÖ Done</div>
                    <ul id="done-tasks">
                        {% for task in completed_tasks %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                            {% if task.assigned_to == username or task.assigned_type == 'everyone' %}
                            {% if task.progress_reports %}
                            <div style="margin-top: 8px;"><strong>Progress Reports:</strong>
                                <ul style="margin-top: 5px;">
                                    {% for report_id, report in task.progress_reports.items() %}
                                    <li style="margin-bottom: 5px;">
                                        - {{ report.progress }} by {{ report.submitted_by }}
                                        {% if report.file %}
                                        <a href="{{ url_for('download_file', group_id=group_id, task_id=task.task_id, username=report.submitted_by, filename=report.file) }}"
                                            target="_blank" style="text-decoration: underline; margin-left: 5px;">
                                            Download
                                        </a>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <div><em>No progress reports yet</em></div>
                            {% endif %}
                            {% endif %}
                        </li>
                        {% else %}
                        <li class="no-tasks">No completed tasks</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="task-section">
                    <div class="collapsible">üéØ To Be Done This Week</div>
                    <ul id="this-week-tasks">
                        {% for task in tasks_this_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div>
                                <span style="font-weight: bold;">Deadline:</span> {{ task.deadline }}
                            </div>
                            <div class="task-description">{{ task.description }}</div>

                            {% if task.assigned_to == username or task.assigned_type == 'everyone' %}
                            <form
                                action="{{ url_for('submit_progress', username=username, group_id=group_id, task_id=task.task_id) }}"
                                method="POST" enctype="multipart/form-data"
                                style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="margin-bottom: 8px;">
                                    <input type="text" name="progress" placeholder="Progress update..." required
                                        style="width: 100%;">
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <input type="file" name="file">
                                </div>
                                <button type="submit">Submit Progress</button>
                            </form>
                            {% endif %}
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for this week</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="task-section">
                    <div class="collapsible">üóìÔ∏è Tasks Next Week</div>
                    <ul id="next-week-tasks">
                        {% for task in tasks_next_week %}
                        <li class="task-card">
                            <div class="task-title">{{ task.task_name }}</div>
                            <div class="task-meta">
                                <div class="assignee-info">Assigned to: {{ task.assigned_to }}</div>
                                <span class="priority-tag priority-{{ task.priority|lower }}">{{ task.priority }}</span>
                            </div>
                            <div class="task-description">{{ task.description }}</div>
                        </li>
                        {% else %}
                        <li class="no-tasks">No tasks for next week</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <script>
            
    function fetchTasks() {
    console.log("Fetching tasks...");
    // You'll need a Flask endpoint that returns task data for the current user/group
    fetch(`/get_tasks_for_user/${groupId}/${username}`) // Assuming such an endpoint exists
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update "Done" tasks
                const doneTasksContainer = document.getElementById('done-tasks');
                doneTasksContainer.innerHTML = ''; // Clear existing tasks
                data.completed_tasks.forEach(task => {
                    const taskElement = document.createElement('li');
                    taskElement.className = 'task-card';
                    taskElement.innerHTML = `
                        <div class="task-title">${task.task_name}</div>
                        <div class="task-meta">
                            <div class="assignee-info">Assigned to: ${task.assigned_to}</div>
                            <span class="priority-tag priority-${task.priority.toLowerCase()}">${task.priority}</span>
                        </div>
                        <div class="task-description">${task.description}</div>
                        ${task.progress_reports ? `
                            <div style="margin-top: 8px;"><strong>Progress Reports:</strong>
                                <ul style="margin-top: 5px;">
                                    ${Object.values(task.progress_reports).map(report => `
                                        <li style="margin-bottom: 5px;">
                                            - ${report.progress} by ${report.submitted_by}
                                            ${report.file ? `<a href="/download_file/${groupId}/${task.task_id}/${report.submitted_by}/${report.file}" target="_blank" style="text-decoration: underline; margin-left: 5px;">Download</a>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : `<div><em>No progress reports yet</em></div>`}
                    `;
                    doneTasksContainer.appendChild(taskElement);
                });

                // Update "This Week" tasks (similar logic)
                const thisWeekTasksContainer = document.getElementById('this-week-tasks');
                thisWeekTasksContainer.innerHTML = '';
                data.tasks_this_week.forEach(task => {
                    const taskElement = document.createElement('li');
                    taskElement.className = 'task-card';
                    taskElement.innerHTML = `
                        <div class="task-title">${task.task_name}</div>
                        <div class="task-meta">
                            <div class="assignee-info">Assigned to: ${task.assigned_to}</div>
                            <span class="priority-tag priority-${task.priority.toLowerCase()}">${task.priority}</span>
                        </div>
                        <div><span style="font-weight: bold;">Deadline:</span> ${task.deadline}</div>
                        <div class="task-description">${task.description}</div>
                        ${(task.assigned_to === username || task.assigned_type === 'everyone') ? `
                            <form action="/submit_progress/${username}/${groupId}/${task.task_id}" method="POST" enctype="multipart/form-data" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="margin-bottom: 8px;"><input type="text" name="progress" placeholder="Progress update..." required style="width: 100%;"></div>
                                <div style="margin-bottom: 8px;"><input type="file" name="file"></div>
                                <button type="submit">Submit Progress</button>
                            </form>
                        ` : ''}
                    `;
                    thisWeekTasksContainer.appendChild(taskElement);
                });

                // Update "Next Week" tasks (similar logic)
                const nextWeekTasksContainer = document.getElementById('next-week-tasks');
                nextWeekTasksContainer.innerHTML = '';
                data.tasks_next_week.forEach(task => {
                    const taskElement = document.createElement('li');
                    taskElement.className = 'task-card';
                    taskElement.innerHTML = `
                        <div class="task-title">${task.task_name}</div>
                        <div class="task-meta">
                            <div class="assignee-info">Assigned to: ${task.assigned_to}</div>
                            <span class="priority-tag priority-${task.priority.toLowerCase()}">${task.priority}</span>
                        </div>
                        <div class="task-description">${task.description}</div>
                    `;
                    nextWeekTasksContainer.appendChild(taskElement);
                });

                // Re-attach event listeners for collapsible sections if they are dynamically re-rendered
                document.querySelectorAll('.collapsible').forEach(el => {
                    if (!el.dataset.listenerAdded) { // Prevent adding multiple listeners
                        el.addEventListener('click', () => toggleCollapsible(el));
                        el.dataset.listenerAdded = 'true';
                    }
                });

            } else {
                console.error('Failed to fetch tasks:', data.message);
            }
        })
        .catch(error => console.error('Error fetching tasks:', error));
}

            function toggleTaskPanel() {
                const panel = document.getElementById('taskPanel');
                panel.classList.toggle('collapsed');
                this.textContent = panel.classList.contains('collapsed') ? '‚â°' : '√ó';
            }

            function toggleCollapsible(element) {
                element.classList.toggle('collapsed');
                const ul = element.nextElementSibling;
                if (ul.style.display === 'none') {
                    ul.style.display = 'block';
                } else {
                    ul.style.display = 'none';
                }
            }
        </script>
    </div>

    <div id="whiteboardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:white; border-radius:8px; padding:20px; width:80%; max-width:800px; max-height:90vh; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Whiteboard</h3>
                <button id="closeWhiteboardBtn"
                    style="background:#ff5555; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Close</button>
            </div>
            <canvas id="whiteboardCanvas"
                style="border:1px solid #ccc; background-color:white; width:100%; height:500px;"></canvas>
            <div style="text-align:center; margin-top:10px;">
                <button id="clearWhiteboardBtn"
                    style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Clear
                    Whiteboard</button>
            </div>
        </div>
    </div>
    <script>
        // UI functions
        function openWhiteboard() {
            document.getElementById('whiteboardModal').style.display = 'flex';
        }

        function closeWhiteboard() {
            document.getElementById('whiteboardModal').style.display = 'none';
        }

        function clearWhiteboard() {
            // Implementation would be in whiteboard.js
            console.log("Whiteboard cleared");
        }
    </script>

    <script>
        // User credentials and API configuration
        const username = "{{ username }}";
        const groupId = "{{ group_id }}";
        const APP_ID = "8f0029e7fd2047339fe6822ab5b59abd";
        const CHANNEL = "{{ group_id }}";
        const UID = Math.floor(Math.random() * 10000);
        let client = null;
        let localTrack = null;

        // Initialize the interface
        function initInterface() {
            fetchMessages();
            document.querySelectorAll('.collapsible').forEach(el => {
                el.classList.remove('collapsed');
                el.nextElementSibling.style.display = 'block';
            });

            // Add event listeners
            document.getElementById('whiteboardToggleBtn').addEventListener('click', openWhiteboard);
            document.getElementById('closeWhiteboardBtn').addEventListener('click', closeWhiteboard);
            document.getElementById('clearWhiteboardBtn').addEventListener('click', clearWhiteboard);
            document.getElementById('taskPanelToggle').addEventListener('click', toggleTaskPanel);
            document.getElementById('joinBtn').addEventListener('click', joinVoiceCall);
            document.getElementById('leaveBtn').addEventListener('click', leaveVoiceCall);

            // Set up collapsible sections
            document.querySelectorAll('.collapsible').forEach(el => {
                el.addEventListener('click', () => toggleCollapsible(el));
            });
        }

        // Set up the interface when page loads
        window.onload = initInterface;
        setInterval(fetchMessages, 5000); // Refresh messages every 5 seconds
    </script>
</body>
</html>
